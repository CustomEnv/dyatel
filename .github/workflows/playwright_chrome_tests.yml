name: Playwright Tests

on:
  push:
    branches:
      - '**'  # Trigger on push to any branch

jobs:
  playwright-docker-chrome:
    runs-on: ubuntu-latest

    container:
      image: mcr.microsoft.com/playwright/python:v1.41.0-jammy
      options: --ipc=host

    steps:
      - name: Checkout code
        uses: actions/checkout@v2

      - name: Set up Python
        uses: actions/setup-python@v2
        with:
          python-version: '3.8'

      - name: Setup tests
        run: |
          python -m pip install --upgrade pip
          pip install tox==3.28.0

      - name: Run Playwright tests
        id: tests
        run: |
          tox -e py38-playwright-chrome -- --headless -v --alluredir=allure-results
        continue-on-error: true
          
      - name: Upload Allure Report as Artifact
        if: steps.tests.outcome == 'failure'
        uses: actions/upload-artifact@v4
        with:
          name: allure-report
          path: allure-report
          retention-days: 1

      - name: Check Test Results
        if: steps.tests.outcome == 'failure'
        run: |
          echo "‚ùå Tests failed! Check the Allure Report for details."
          exit 1 

  update_screenshots:
    runs-on: ubuntu-latest
    needs: playwright-docker-chrome
    if: ${{ github.event_name == 'workflow_dispatch' }}  # Only runs when manually triggered
    continue-on-error: true  # This ensures the job doesn't stop if previous jobs fail

    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Download artifacts
        uses: actions/download-artifact@v3
        with:
          name: allure-report
          path: allure-report

      - name: Install Pillow
        run: |
          python -m pip install --upgrade pip
          pip install Pillow==9.4.0

      - name: Replacing references
        run: |
          python tests/adata/update_references_from_allure_report.py allure-report
      
      - name: Stage changes
        run: |
          git config --global user.name "GitHub Actions"
          git config --global user.email "actions@github.com"
          git add tests/adata/visual/reference

      - name: Commit changes
        run: |
          git commit -m "Processed artifacts and updated files" || echo "No changes to commit"

      - name: Push changes
        run: |
          git push origin HEAD:${{ github.ref }}  # Push to the same branch as the current commit
